{% extends "base.html" %}
{% load static %}
{% block title %}Store{% endblock title %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
  let isFillRequest = [undefined, false, false, false, false, false, false, false, false]
  let deleteElemIndex = [undefined, 1, 1, 1, 1, 1, 1, 1, 1]
  let currentFillingElem = [undefined, 3, 3, 3, 3, 3, 3, 3, 3]
  let emptyCounts = [undefined, 0, 0, 0, 0, 0, 0, 0, 0]
  let ids = [undefined, 1, 2, 5, 6, 4, 3, 7, 8]
  let fillIntervals = []
  let products = [undefined,
    `<img src={% static 'images/apple.png' %} height=30>`,
    `<img src={% static 'images/pineapple.png' %} height=30>`,
    `<img src={% static 'images/carrot.png' %} height=30>`,
    `<img src={% static 'images/cucumber.png' %} height=30>`,
    `<img src={% static 'images/milk.png' %} height=30>`,
    `<img src={% static 'images/orange_juice.png' %} height=30>`,
    `<img src={% static 'images/potato.png' %} height=30>`,
    `<img src={% static 'images/tomato.png' %} height=30>`,
  ]
  let productsCountInStore = [undefined,
    JSON.parse("{{ storeProducts|escapejs }}")[0].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[1].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[4].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[5].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[3].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[2].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[6].fields.product_count,
    JSON.parse("{{ storeProducts|escapejs }}")[7].fields.product_count,
  ]
  let productsCountInStorage = [undefined,
    JSON.parse("{{ storageProducts|escapejs }}")[0].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[1].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[4].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[5].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[3].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[2].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[6].fields.product_count,
    JSON.parse("{{ storageProducts|escapejs }}")[7].fields.product_count
  ]
  let isReady = [undefined, true, true, true, true, true, true, true, true]


  window.addEventListener('load', () => {
    for (let i = 1; i < 9; i++) {
      let currentProductsInShelf = productsCountInStore[i]
      let shelf = document.getElementById('shelf' + i)
      if (currentProductsInShelf < 9) {
        for (let j = 1; j < 11 - currentProductsInShelf; j++) {
          shelf.childNodes.item(j * 2 - 1).innerHTML = ""
          deleteElemIndex[i] += 2
          emptyCounts[i]++
        }
        emptyCounts[i]--
        deleteElemIndex[i] -= 2
      }
      shelf.childNodes.forEach(element => {
        element.style = 'animation: none;'
      })
      fillIntervals[i] = setInterval(() => {
        if (emptyCounts[i] > 5) {
          clearInterval(fillIntervals[i])
          fillShelf('shelf' + i)
        }
      })
      let shelfFiller = document.getElementById('shelf_up' + i)
      shelfFiller.style = 'left: -85px'
      shelfFiller.childNodes.forEach(element => {
        element.style = 'animation: none;'
      })
    }
  })


  function fillShelf(shelfId) {
    if (productsCountInStorage[shelfId.slice(-1)] > emptyCounts[shelfId.slice(-1)]) {
      productsCountInStore[shelfId.slice(-1)] = 10
      productsCountInStorage[shelfId.slice(-1)] -= emptyCounts[shelfId.slice(-1)]
      sendAjaxForm(shelfId)
      isReady[shelfId.slice(-1)] = false
      isFillRequest[shelfId.slice(-1)] = true
      fillIntervals[shelfId.slice(-1)] = setInterval(() => {
        let takeButton = document.getElementById('take-button' + shelfId.slice(-1))
        takeButton.innerHTML = 'Filling<br>wait...<br>🡄◼◼◼'
        takeButton.disabled = true
        fill(shelfId)
      }, 1000)
    } else {
      sendNotificationNoProductsLeft(shelfId)
    }
  }


  function sendNotificationNoProductsLeft(shelfId) {
    console.log('No products left, shelf ' + shelfId.slice(-1) + ' empty!')
  }


  function take(shelfId) {
    let elementsTook = 1
    let shelf = document.getElementById(shelfId)
    if (isReady[shelfId.slice(-1)] && emptyCounts[shelfId.slice(-1)] < 9) {
      isReady[shelfId.slice(-1)] = false
      let lastChild = shelf.childNodes.item(shelf.childNodes.length - 2)
      let animationEnd = () => {
        shelf.childNodes.item(deleteElemIndex[shelfId.slice(-1)]).innerHTML = ""
        lastChild.innerHTML = products[shelfId.slice(-1)]
        if (emptyCounts[shelfId.slice(-1)] == 9) {
          lastChild.innerHTML = ``
        }
        isReady[shelfId.slice(-1)] = true
        lastChild.removeEventListener('animationend', animationEnd)
      }
      let animationEndGeneric = (event) => {
        event.currentTarget.style = 'animation: none;'
        event.currentTarget.removeEventListener('animationend', animationEndGeneric)
      }

      lastChild.innerHTML = ''
      lastChild.addEventListener('animationend', animationEnd)
      shelf.childNodes.forEach(element => {
        element.style = 'animation: ""; animation-iteration-count: ' + elementsTook + ';'
        element.addEventListener('animationend', animationEndGeneric)
      })

      deleteElemIndex[shelfId.slice(-1)] += 2
      emptyCounts[shelfId.slice(-1)]++
    } else if (isReady[shelfId.slice(-1)]) {
      fillShelf(shelfId)
    }
  }


  function fill(shelfId) {
    let takeButton = document.getElementById('take-button' + shelfId.slice(-1))
    let elementsGave = 1
    let shelfUpId = 'shelf_up' + shelfId.slice(-1)
    let shelfFiller = document.getElementById(shelfUpId)
    if (isReady[shelfId.slice(-1)] && emptyCounts[shelfId.slice(-1)] > 0) {
      isReady[shelfId.slice(-1)] = false
      let firstChild = shelfFiller.childNodes.item(currentFillingElem[shelfId.slice(-1)])
      let animationEnd = () => {
        firstChild.innerHTML = products[shelfId.slice(-1)]
        isReady[shelfId.slice(-1)] = true
        firstChild.removeEventListener('animationend', animationEnd)
      }
      let animationEndGeneric = (event) => {
        event.currentTarget.style = 'animation: none;'
        event.currentTarget.removeEventListener('animationend', animationEndGeneric)
      }

      firstChild.addEventListener('animationend', animationEnd)
      shelfFiller.childNodes.forEach(element => {
        element.style = 'animation: ""; animation-iteration-count: ' + elementsGave + ';'
        element.addEventListener('animationend', animationEndGeneric)
      })
      currentFillingElem[shelfId.slice(-1)] += 2
      emptyCounts[shelfId.slice(-1)]--
    } else if (emptyCounts[shelfId.slice(-1)] > 0 && isFillRequest[shelfId.slice(-1)]) {
      isFillRequest[shelfId.slice(-1)] = false
      isReady[shelfId.slice(-1)] = true
    } else if (isReady[shelfId.slice(-1)]) {
      clearInterval(fillIntervals[shelfId.slice(-1)])
      deleteElemIndex[shelfId.slice(-1)] = 1
      currentFillingElem[shelfId.slice(-1)] = 3
      let shelf = document.getElementById(shelfId)
      shelf.childNodes.forEach(element => {
        element.innerHTML = products[shelfId.slice(-1)]
      })
      shelfFiller.childNodes.forEach(element => {
        element.innerHTML = ''
      })
      fillIntervals[shelfId.slice(-1)] = setInterval(() => {
        if (emptyCounts[shelfId.slice(-1)] > 5) {
          clearInterval(fillIntervals[shelfId.slice(-1)])
          fillShelf(shelfId)
        }
      })
      takeButton.innerHTML = 'Take<br>🡄◼◼◼'
      takeButton.disabled = false
    }
  }


  function sendAjaxForm(ajax_form) {
    productsCountInStore[ajax_form.slice(-1)]--
    let storeProducts = productsCountInStore[ajax_form.slice(-1)]
    let storageProducts = productsCountInStorage[ajax_form.slice(-1)]
    let id = ids[ajax_form.slice(-1)]
    console.log(id)
    $.ajax({
      url: '{% url "store" %}', //url страницы (action_ajax_form.php)
      type: "POST", //метод отправки
      data: { "product_id": id, "storageProducts": storageProducts, "storeProducts": storeProducts },
      success: (result) => {
        console.log('success')
        return false
      }
    })
  }


  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  let csrftoken = getCookie('csrftoken');


  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });


  $(document).ready(function () {
    for (let i = 1; i < 9; i++) {
      $("#form" + i).submit(function (e) {
        e.preventDefault()
        sendAjaxForm('form' + i)
      })
    }
  })
</script>
<link rel="stylesheet" href="{% static 'css/store_load.css' %}" />
{% if user.is_authenticated %}
<h1 class='regular__item'>Store</h1>
<table>
  <tr>
    <td>
      <p class='regular__item'>Shelf №1<br>========================</p>
      <div class="lds-ellipsis" id='shelf1'>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
        <div><img src="{% static 'images/apple.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up1'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form1'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf1')" id='take-button1'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №2<br>========================</p>
      <div class="lds-ellipsis" id='shelf2'>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
        <div><img src="{% static 'images/pineapple.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up2'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form2'>
        {% csrf_token %}
        <button type='submit' class='button7' onclick="take('shelf2')" id='take-button2'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №3<br>========================</p>
      <div class="lds-ellipsis" id='shelf3'>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
        <div><img src="{% static 'images/carrot.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up3'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form3'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf3')" id='take-button3'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №4<br>========================</p>
      <div class="lds-ellipsis" id='shelf4'>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
        <div><img src="{% static 'images/cucumber.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up4'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form4'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf4')" id='take-button4'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
  </tr>
  <tr>
    <td>
      <p class='regular__item'>Shelf №5<br>========================</p>
      <div class="lds-ellipsis" id='shelf5'>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
        <div><img src="{% static 'images/milk.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up5'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form5'>
        {% csrf_token %}
        <button type='submit' class='button7' onclick="take('shelf5')" id='take-button5'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №6<br>========================</p>
      <div class="lds-ellipsis" id='shelf6'>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
        <div><img src="{% static 'images/orange_juice.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up6'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form6'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf6')" id='take-button6'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №7<br>========================</p>
      <div class="lds-ellipsis" id='shelf7'>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
        <div><img src="{% static 'images/potato.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up7'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form7'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf7')" id='take-button7'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
    <td>
      <p class='regular__item'>Shelf №8<br>========================</p>
      <div class="lds-ellipsis" id='shelf8'>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
        <div><img src="{% static 'images/tomato.png' %}" height=30></div>
      </div>
      <div class="lds-ellipsis" id='shelf_up8'>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
      <p class='regular__item'>========================</p>
    </td>
    <td>
      <form method='POST' id='form8'>
        {% csrf_token %}
        <button class='button7' onclick="take('shelf8')" id='take-button8'>Take<br>🡄◼◼◼</button>
      </form>
    </td>
  </tr>
</table>
{% else %}
<h1 class='regular__item'>You are not authenticated to see this page</h1>
{% endif %}
{% endblock content %}
