{% extends "base.html" %}
{% load googlecharts %}

{% block title %}Аналитика{% endblock title %}

{% block content %}
  {% if user.is_authenticated %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']})
      google.charts.setOnLoadCallback(drawCharts)

      let basicOptions = {
        backgroundColor: "#fff",
        colors: ["#09f"],
        lineWidth: 3,
        gridlineColor: "#ddd",
        legend: "none",
        vAxis: {minValue: 0},
        chartArea: {left: 40, top: 20, width: 200, height: 160},
        width: 260,
        height: 220
      }
      const soldEveryDayOptions = basicOptions

      function drawCharts() {
        {% for fullStatsForSingleShelf in fullStatsForEachShelf %}
          {% with fullStatsForSingleShelf|first as shelfProps %}
            {% with fullStatsForSingleShelf|last as shelfStats %}
              {% for statsName, stats in shelfStats.items %}
                {% if statsName == "soldEveryDay" %}
                  let soldEveryDayData_{{ shelfProps.id }} = new google.visualization.DataTable()
                  soldEveryDayData_{{ shelfProps.id }}.addColumn('string', 'Date')
                  soldEveryDayData_{{ shelfProps.id }}.addColumn('number', 'Count')
                  {% for row in stats %}
                    soldEveryDayData_{{ shelfProps.id }}.addRow(['{{ row|first }}', {{ row|last }}])
                  {% endfor %}

                  let chart_{{ shelfProps.id }} = new google.visualization.LineChart(document.getElementById('soldEveryDayGraph_{{ shelfProps.id }}'))
                  chart_{{ shelfProps.id }}.draw(soldEveryDayData_{{ shelfProps.id }}, soldEveryDayOptions)
                {% endif %}
              {% endfor %}
            {% endwith %}
          {% endwith %}
        {% endfor %}
      }
    </script>



    <div class="container-md">
      {% for fullStatsForSingleShelf in fullStatsForEachShelf %}
        {% with fullStatsForSingleShelf|first as shelfProps %}
          Название полки: {{ shelfProps.shelf_name }}
          {% with fullStatsForSingleShelf|last as shelfStats %}
            {% for statsName, stats in shelfStats.items %}
              {% if statsName == "soldEveryDay" %}
                <div class="row">
                  <div class="col-md-4">
                    Статистика продаж:
                    <div id="soldEveryDayGraph_{{ shelfProps.id }}"></div>
                  </div>
                  {% comment %} <div class="col-md-4 mt-4" id="secondGraph"></div> {% endcomment %}
                  {% comment %} <div class="col-md-4 mt-4" id="thirdGraph"></div> {% endcomment %}
                </div>
              {% endif %}
            {% endfor %}
          {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}
{% endblock content %}
